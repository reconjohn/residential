---
title: "Agenda"
author: "Yohan Min"
date: "November 30, 2018"
output:
  html_document:
    keep_md: yes
    preserve_yaml: yes
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---

```{r setup, include=FALSE, echo= F}
knitr::opts_chunk$set(echo = FALSE, warning= F, message= F, fig.align="center")
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(forcats)
library(pander)
library(stringr)
library(psych)
library (cluster)
library(reshape)
library(reshape2)
library(som)
library(GPArotation)
library(corrplot)
library(tibble)
library(GGally)
# library(MASS)
```

## Energy code

### Title 24 vs. IECC
연방정부 기준인 IECC 를 적어도 만족시키는 주정부 energy 기준이 있어야 하는데, CA 의 경우 2016 Building Energy Efficiency Standards Title 24, Part 6 이 2015 IECC 를 넘어서는 결과를 보여주고 있다. 

### 2018 IECC 
가장 최근 버전으로 - APPENDIX RA SOLAR-READY PROVISIONS—DETACHED ONE- AND TWOFAMILY DWELLINGS, MULTIPLE SINGLE-FAMILY DWELLINGS (TOWNHOUSES) - solar ready 에 대한 조건이 있다. 

### 2019 Residential Compliance Manual 
CA 에서 나온 것으로, PV 설치를 강제하고 있고, 예외에 한에서 역시 solar ready 를 강제하고 있다. Seattle 이 경우 2017 residential code 가 해당. Residential 의 경우 solar ready 는 residential code 에 있는데, commercial 의 경우 solar ready 는 building code 가 아닌 energy code 에 있다. 참고로, single family 와 low rise multifamily 는 residential code (특별 building code 로 보면 될 듯), 그 외는 building code. 그리고 solar 를 직접 설치 했을 때는 NEC 의 electrical code 와 관계한 electrical permit 을 받아야 한다. 

> The California Energy Code, part 6 of the California Building Standards Code which is title 24 of the California Code of Regulations, also titled The Energy Efficiency Standards for Residential and Nonresidential Buildings, were created by the California Building Standards Commission in 1978 in response to a legislative mandate to reduce California's energy consumption. The standards are updated periodically by the California Energy Commission to allow consideration and possible incorporation of new energy efficiency technologies and methods. The California Energy Code (CEC) contains energy conservation standards applicable to most residential and nonresidential buildings throughout California, including schools. - solar ready, residential compliance manual.

> There are 3 different kinds of building codes: private sector, federal sector, and international. The private sector codes are associated with state and local jurisdiction. States and local jurisdictions have different energy codes that they follow based on climate, geography, and many other contributing factors. The two primary baseline codes for the private sector are the International Energy Conservation Code (IECC), and the ANSI/ASHRAE/IESNA Standard 90.1 energy standard for Buildings Except Low-Rise Residential Buildings (ASHRAE 90.1).[4] States and local governments adopt and enforce these energy codes. The standards are published by national organizations such as ASHRAE. The International Code Council (ICC) develops the codes and standards used to construct residential and commercial buildings, including homes and schools.[5] Within the ICC is the IECC which is a subset of the ICC. The IECC is a model energy code, but it is written in mandatory, enforceable language, so that state and local jurisdictions can easily adopt the model as their energy code.[6] The IECC references several ASHRAE Standards, in particular the ASHRAE 90.1 for commercial building construction.

## OSHA

* Roof slope: OSHA defines a low-slope roof as a roof having a slope of less than or equal to 4 inches of vertical rise for every 12 inches horizontal length (4:12) (1926.500(b)—definitions). This is important because the OSHA definition is used as a basis for implementing low-slope fall-protection measures, such as warningline
systems and safety monitors.

* Ladder: angle 75 degree, one-quarter the working length of the ladder (a 1:4 ratio) (29 CFR 1926.1053(b)(5)(i)). 3 rungs (1 ft apart) above the roof, The side rails of the ladder generally must extend at least 3 feet above the upper landing surface that the worker is trying to access (29 CFR 1926.1053(b)(1)).

* Anchor: OSHA standard regarding anchorages can be found in 29 CFR 1926.502(d)(15)

## Risk per full-time workers 
![Top 3 risks are related to solar installation on the roof](./Figs/PTD.jpg)

## Ideal design for safety from the interviews 
* Roof pitch: lower than 5/12 – 7/12 to work easy, fall
* Roof material: composition not to be slippery, fall
* Roof structure: no obstruction no to be interrupted, trip, complexity
* Roof condition: accessories pre-installed to reduce the scope, complexity
* Anchor point: pre-installed to be efficient, fall
* Access: low height, enough space for easier access, fall
* Additional: setback, snow guard, guardrail to prevent fall
* Electrical: micro inverter, conduit pre-run, reserving spaces, electric shock, complexity


## Solar installation trend in Seattle

```{r load data}
load("../data/derived/prj1.Rdata")
load("../data/derived/prj2.Rdata")
load("../data/derived/prj3.Rdata")
```

```{r}

inst %>% 
  mutate(year = year(CompletedDate)) %>% 
  group_by(Class, year) %>% 
  summarise(install = n()) %>% 
  ggplot(aes(x = year, y = install, group = Class, color = Class))+
  geom_line(size = 1)+
  xlab("Year") + ylab("Number of installation") +
  theme_bw() +
  theme(legend.position = c(0.90, 0.25),
        legend.background = element_rect(fill="transparent")) +
  scale_x_continuous(breaks = seq(2000, 2019, by = 1))
```

## Solar installation trend by contractors 

```{r}
inst %>% 
  mutate(year = year(CompletedDate)) %>% 
  group_by(Installer, year) %>% 
  summarise(install = n()) %>% 
  arrange(desc(install)) %>% 
  left_join(top, by = c("Installer")) %>% 
  filter(`top installer` == "Y") %>% 
  ggplot(aes(x = year, y = install, group = Installer, 
             color = Installer))+
  geom_line(size = 1)+
  xlab("Year") + ylab("Number of installation") +
  theme_bw() +
  theme(legend.position = c(0.2, 0.7),
        legend.background = element_rect(fill="transparent")) +
  scale_x_continuous(breaks = seq(2000, 2019, by = 1))
```


## Cumulative solar installation per census track

```{r}
temp_spatial %>% 
  filter(date > as.Date("01/01/2005", "%m/%d/%Y")) %>% 
  ggplot(aes(x = date, y = sum, group = geoid, color = `Over 20`))+
  geom_line(size = 1, alpha = 0.4)+
  scale_color_manual(name ="Above 20 installation", values = c("red", "black"))+
  xlab("Year") + ylab("Cumulative number of installation") +
  theme_bw() +
  theme(legend.position = c(0.2, 0.7),
        legend.background = element_rect(fill="transparent")) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y")
```


## Residential household in Seattle

```{r, dev="svg", fig.height=4}
ggplot(pot, aes(x = `Income class`, y = hh_prp, group = geoid, color = `Income class`)) + 
  facet_grid(type ~ own) +
  geom_point(alpha = 0.3, position = position_jitter(width = 0.5)) + 
  theme_bw() + ylab("Household proportion") +
  theme(legend.position = c(0.8, 0.3),
                     legend.background = element_rect(color = 1))
```


## Residential solar potential (MWh) in Seattle

```{r, dev="svg", fig.height=4}
ggplot(pot, aes(x = `Income class`, y = `Total MWh`, group = geoid, color = `Income class`)) + 
  facet_grid(type ~ own) +
  geom_point(alpha = 0.3, position = position_jitter(width = 0.5, height = 2)) + 
  theme_bw() + theme(legend.position = c(0.7, 0.3),
                     legend.background = element_rect(color = 1))
```

## Residential solar potential (MWh/ household) in Seattle

```{r, dev="svg", fig.height=4}
ggplot(pot, aes(x = `Income class`, y = `MWh/house hold`, group = geoid, color = `Income class`)) + 
  facet_grid(type ~ own) +
  geom_point(alpha = 0.3, position = position_jitter(width = 0.5, height = 2)) + 
  theme_bw() + theme(legend.position = c(0.2, 0.3),
                     legend.background = element_rect(color = 1))
```


## Histograms of multiple variables 

```{r, fig.height=5}
fhist <- regr[, c(-1, -11)]
par(mfrow=c(3,4))
for(i in 1:length(fhist)){
  hist(fhist[[i]], main= paste("Histogram of\n", names(fhist)[i]),
       xlab= names(fhist)[i], col="gold")
  abline(v = median(fhist[[i]]), col="red", lwd=4)
  text(median(fhist[[i]]), 0, round(median(fhist[[i]]),2), col = "blue")
}
```

## Boxplot for overall potential solar

```{r}
seattle %>% 
  gather(class, mwh, very_low_mf_own_mwh:high_sf_rent_mwh) %>% 
  select(geoid, class, mwh) %>% 
  mutate(class = parse_factor(class, levels = names(seattle))) %>% 
  mutate(cl = ifelse(str_detect(class, "verylow|low|mod"), "low",
                                 ifelse(str_detect(class, "mid"), "mid", 
                                        ifelse(str_detect(class, "high"), "high", NA)))) %>%
  mutate(cl = parse_factor(cl, levels = c("low", "mid", "high"))) %>% 
  ggplot(aes(x = class, y = mwh, color = class)) +
  geom_boxplot() +
  facet_wrap( ~ cl) +
  scale_y_log10() +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
      axis.ticks.x = element_blank())
```


## Cor plot

```{r}
### cor plot
regr_p <- regr %>% 
  select(-geoid, -lihtc)

corrplot(cor(regr_p), method = "ellipse")
```


## Regression

```{r}
reg <- lm(sol_instl ~ .,regr[-c(1)])
# stepAIC(reg)

summary(lm(formula = sol_instl ~ hu_med_val + hu_ex_1000,
           data = regr[-c(1)]))
```

## Residual from the OLS 
<center>

![OLS residual mapping](./Figs/OLS-resid.png){width=450px}

</center>

## Geographically weighted regression (GWR)
<center>

![Residual mapping for GWR](./Figs/GWR-resid.png){width=450px}

</center>

## Geographically weighted impact 
<center>

![Impact of housing median value](./Figs/coef1.png){width=450px}

</center>

<center>

![impact of housing cost over $1k/ month](./Figs/coef2.png){width=450px}

</center>

<center>

![Solar installation hotspot](./Figs/hotspot.png){width=450px}

</center>

<center>

![Solar installation outlier](./Figs/outlier.png){width=450px}

</center>


## Factor analysis (Parallel screen) 

```{r}
fct <- regr%>% 
  select(-geoid, -sol_instl, -lihtc)

fa.parallel(fct,fa="fa",n.iter=50)
```

## Factor analysis (Plot)

```{r}
fa <- fa(fct,nfactors=3,rotate="promax",fm="ml")

factor.plot(fa, labels=rownames(fa$loadings))
```

## Factor analysis (Diagram)

```{r}
fa.diagram(fa,simple=T)
```

## Factor correlation for solar installation

```{r}
dat <- fa$scores
dim(dat)
plot(dat[,1], regr[[14]], xlab = "The 1st factor", ylab = "Solar installation")
```

## Factor regression 
```{r}
summary(lm(regr[[14]] ~ dat[,1] + dat[,2] + dat[,3]))
```

## Cluster analysis
```{r}
set.seed(5099)
kme <- kmeans(dat,center=3)
table(kme$cluster) #number of samples in each cluster
Group1 <- kme$centers[1,]
Group2 <- kme$centers[2,]
plot(Group1,Group2,type="n")
text(Group1,Group2, labels=colnames(dat))
```

## Cluster within cluster sum of squares (WCSS)

```{r}
sum(kme$withinss)
wss <- (nrow(dat)-1)*sum(apply(dat,2,var))
for (i in 2:9) wss[i] <- sum(kmeans(dat,centers=i)$withinss)
plot(1:9, wss, type="b", xlab="Number of Clusters",ylab="Within groups sum of squares")
```

## Optimal cluster 

```{r}

performance=c()
for (i in rep(1:100,times=30)) {
  clust=kmeans(dat,i)
  performance=c(performance,1-clust$tot.withinss/clust$totss)
}
perf_df=data.frame(metrics=performance,number_of_center=rep(1:100,times=30))
ggplot(perf_df,aes(x=number_of_center,y=metrics)) +
  geom_point(alpha=0.2) +
  geom_vline(xintercept = 3,color='red')

```

## Cluster plot
```{r}
pairs(dat, col=kme$cluster)
clusplot(dat, kme$cluster, color=TRUE,shade=TRUE, labels=5, lines=0)
```

## 3D plot
```{r}
library(rgl)
plot3d(fa$scores, col = kme$cluster)
```

![](./Figs/3D.jpg)

## Cluster with boxplot

```{r}
dat <- as.data.frame(dat)
dat$cluster=as.factor(kme$cluster)
ggpairs(dat, mapping=aes(color=cluster))+ 
  theme_bw()
```

## Cluster plot with smooth

```{r}
ggpairs(dat, columns = 1:3, 
        aes(color=cluster, alpha=0.4), 
        title="Scatterplot Matrix",
        upper=list(continuous="density", combo="box"),
        lower=list(continuous="smooth", combo="dot")) +
  theme_light() +
  theme(plot.title=element_text(size=10))+ 
  theme_bw()
```

## Data analysis 1

```{r}
c_reg <- regr
c_reg$cluster <- as.factor(kme$cluster)

c_reg %>% 
  ggplot(aes(x = cluster, y = sol_instl, color = cluster)) +
  geom_boxplot() +
  ggtitle("Solar installation pattern per cluster")+ 
  theme_bw()

```


## Data analysis 2
```{r}

c_reg %>% 
  ggplot(aes(x = hu_ex_1000, y = sol_instl, color = cluster, size = lihtc)) +
  geom_point() +
  ggtitle("Solar installation pattern per cluster")+ 
  theme_bw()
```

## Data analysis 3
```{r}
c_reg %>% 
ggplot(aes(x = hu_med_val, y = sol_instl, color = cluster)) +
  geom_point(alpha = 0.4)+
  geom_smooth(span = 0.9)+ 
  theme_bw()
```

<center>

![Clustered census track](./Figs/cluster.png){width=450px}

</center>
