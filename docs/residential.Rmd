---
title: "Characteristics of Residential Solar in Seattle"
author: "Yohan Min"
date: "`r gsub(' 0', ' ', format(Sys.Date(), format='%b %d, %Y'))`"
header-includes: #allows you to add in your own Latex packages
- \usepackage{float} #use the 'float' package
- \floatplacement{figure}{H} #make every figure with caption = h
- \usepackage[fontsize=11pt]{scrextend}
output:
  word_document:
  pdf_document:
    latex_engine: xelatex
  html_document:
    keep_md: yes
    preserve_yaml: yes
    toc: yes
    toc_float: yes
    number_sections: true
---

```{r setup, include=FALSE, echo= F}
knitr::opts_chunk$set(echo = FALSE, warning= F, message= F, fig.align="center")
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2) 
library(lubridate)
library(forcats)
library(pander)
library(stringr)
library(psych)
library (cluster)
library(reshape)
library(reshape2)
library(som)
library(GPArotation)
library(corrplot)
library(tibble)
library(GGally)
# library(MASS)
library(faraway)
```


## Solar installation trend in Seattle

> Why is there a drop in residential solar installation in Seattle from 2016? The study area is Seattle and the unit of analysis is census track. 

```{r load data}
load("../data/derived/prj1.Rdata")
load("../data/derived/prj2.Rdata")
load("../data/derived/prj3.Rdata")
```

```{r}

inst %>%
  mutate(year = year(CompletedDate)) %>%
  group_by(Class, year) %>%
  summarise(install = n()) %>%
  ggplot(aes(x = year, y = install, group = Class, color = Class))+
  geom_line(size = 1)+
  xlab("Year") + ylab("Number of installation") +
  theme_bw() +
  theme(legend.position = c(0.90, 0.25),
        legend.background = element_rect(fill="transparent")) +
  scale_x_continuous(breaks = seq(2000, 2019, by = 1))
```

## Solar installation trend by contractors

```{r}
inst %>%
  mutate(year = year(CompletedDate)) %>%
  group_by(Installer, year) %>%
  summarise(install = n()) %>%
  arrange(desc(install)) %>%
  left_join(top, by = c("Installer")) %>%
  filter(`top installer` == "Y") %>%
  ggplot(aes(x = year, y = install, group = Installer,
             color = Installer))+
  geom_line(size = 1)+
  xlab("Year") + ylab("Number of installation") +
  theme_bw() +
  theme(legend.position = c(0.2, 0.7),
        legend.background = element_rect(fill="transparent")) +
  scale_x_continuous(breaks = seq(2000, 2019, by = 1))
```


## Residential households in Seattle

```{r}
ggplot(pot, aes(x = `Income class`, y = hh_prp, group = geoid, color = `Income class`)) +
  facet_grid(type ~ own) +
  geom_point(alpha = 0.3, position = position_jitter(width = 0.5)) +
  theme_bw() + ylab("Households proportion") +
  theme(legend.position = c(0.8, 0.3),
                     legend.background = element_rect(color = 1))
```


## Residential solar potential (MWh/ household) in Seattle

```{r}
ggplot(pot, aes(x = `Income class`, y = `MWh/house hold`, group = geoid, color = `Income class`)) +
  facet_grid(type ~ own) +
  geom_point(alpha = 0.3, position = position_jitter(width = 0.5, height = 2)) +
  theme_bw() + theme(legend.position = c(0.2, 0.3),
                     legend.background = element_rect(color = 1))
```

## Residential solar potential (MWh) in Seattle

> There are two noticable groups in social characteristics with solar potential (MWh): A group of high income, single family housing owners and a group of low income, multifamily housing renters. These two groups have comparatively higher potential for solar electricity generation. 

```{r}
ggplot(pot, aes(x = `Income class`, y = `Total MWh`, group = geoid, color = `Income class`)) +
  facet_grid(type ~ own) +
  geom_point(alpha = 0.3, position = position_jitter(width = 0.5, height = 2)) +
  theme_bw() + theme(legend.position = c(0.7, 0.3),
                     legend.background = element_rect(color = 1))
```

## Boxplot for overall potential solar

```{r}
seattle %>%
  gather(class, mwh, very_low_mf_own_mwh:high_sf_rent_mwh) %>%
  select(geoid, class, mwh) %>%
  mutate(class = parse_factor(class, levels = names(seattle))) %>%
  mutate(cl = ifelse(str_detect(class, "verylow|low|mod"), "low",
                                 ifelse(str_detect(class, "mid"), "mid",
                                        ifelse(str_detect(class, "high"), "high", NA)))) %>%
  mutate(cl = parse_factor(cl, levels = c("low", "mid", "high"))) %>%
  ggplot(aes(x = class, y = mwh, color = class)) +
  geom_boxplot() +
  facet_wrap( ~ cl) +
  scale_y_log10() +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
      axis.ticks.x = element_blank())
```

## Histograms of multiple variables

> Variables are collected through several datasets including National Renewable Energy Laboratory (NREL) REPLICA 2018, American Community Survey (ACS) 2011 - 2015, the Department of Housing and Urban Development (HUD) 2017 and City of Seattle open data portal.  

```{r, fig.height=5}
fhist <- regrs[, c(-1, -11)]
par(mfrow=c(3,4))
for(i in 1:length(fhist)){
  hist(fhist[[i]], main= paste("Histogram of\n", names(fhist)[i]),
       xlab= names(fhist)[i], col="gold")
  abline(v = median(fhist[[i]]), col="red", lwd=4)
  text(median(fhist[[i]]), 0, round(median(fhist[[i]]),2), col = "blue")
}
```

## Cor plot

> The number of solar installation per census track is the dependant variable (sol_instl). Rest of variables are as follows. 

> * hu_own: a proportion of owner-occupied housing unit
> * hu_blt1970: a proportion of housing units bulit before 1970
> * hu_no_mor: a proportion of housing units without morgage
> * hu_med_val: housing unit median value
> * hu_ex_1000: total number of owner-occupied units with housing costs greater than $1000/month 
> * edu: a proportion of over 25 year old population with college degree and above
> * wh_race: a proportion of caucasian population
> * hh_med_income: household median income
> * hh_gini_index: household GINI Index of income inequality
> * lihtc: low income tax credit qualification (T/F) 	
> * hh_high_sf_own: a proportion of households of high income, single family housing owner
> * hu_mwh: solar elergy potential (MWh) per housing unit in a census track 

> The dependant variable (sol_instl) is correlated to all the variables except for the household GINI index and LITHC qualification. 

```{r}
### cor plot
regr_p <- regrs %>%
  select(-geoid, -lihtc)

corrplot(cor(regr_p), method = "ellipse")
```


## Regression

> By exploratory regression analyses, the best model with the highest R-squared (0.61) and lowest AIC (653.69) was chosen with the two variables, hu_med_val and hu_ex_1000 through OLS.

```{r}
reg <- lm(sol_instl ~ .,regrs[-c(1)])
# stepAIC(reg)

summary(lm(formula = sol_instl ~ hu_med_val + hu_ex_1000,
           data = regrs[-c(1)]))
```

## Residual from the OLS

> The residual plot shows it is biased and clustered indicating the model is not catching well the variability of the dependant variable. 

<center>

![OLS residual mapping](./Figs/OLS-resid.png){width=450px}

</center>

## Geographically weighted regression (GWR)

> Another method named Geographically Weighted Regression (GWR) was performed with the outcomes of R-squared (0.76) and AIC (625.54), which are better than the previous OLS model. Residual map shows random pattern as confirmed by auto correlation analysis with Moran's index of 0.028 and z-score of 0.75. 

<center>

![Residual mapping for GWR](./Figs/GWR-resid.png){width=450px}

</center>

## Geographically weighted impact

> This model tells that housing unit median value affects residential solar installation more in the area of darker red as below. These areas are more senstive to the housing unit median value with respect to the residential solar installation. 

<center>

![Impact of housing median value](./Figs/coef1.png){width=450px}

</center>

> For the variable, total number of owner-occupied units with housing costs greater than $1000/month, the more sensitive area is presented as darker red in the map below. 

<center>

![impact of housing cost over $1k/ month](./Figs/coef2.png){width=450px}

</center>

## Hotspot analysis of residential solar installation 

> Each point represents the house unit with residential solar system installed on its building since 2003. By aggregating these points to the census track, hotspot areas and outliers were identified as below. 

<center>

![Solar installation hotspot](./Figs/hotspot.png){width=450px}

</center>

<center>

![Solar installation outlier](./Figs/outlier.png){width=450px}

</center>


## Factor analysis (Parallel screen)

> It would be useful to include all the variables rather than selecting only two variables in the model. With a factor analysis, all the variables would be used for model identification.  The parallel screen confirms 2 or 3 factors would be appropriate. 

```{r}
fct <- regrs%>%
  select(-geoid, -sol_instl, -lihtc)

fa.parallel(fct,fa="fa",n.iter=50)
```

## Factor analysis (Plot)

> The 3 factos partially explain each variable depending on the latent characteristics. 

```{r}
fa <- fa(fct,nfactors=3,rotate="promax",fm="ml")

factor.plot(fa, labels=rownames(fa$loadings))
```

## Factor analysis (Diagram)

> The first factor (ML1) is more related to the higher housing stability, the 2nd factor (ML2) to the higher economic status, and the 3rd factor (ML3) is more related to the higher income inequality. 

```{r}
fa.diagram(fa,simple=T)
```

## Factor correlation for solar installation

> The most loaded, ML1 is positively correlated with the solar installation variable. 

```{r}
dat <- fa$scores
dim(dat)
plot(dat[,1], regrs[[14]], xlab = "The 1st factor", ylab = "Solar installation")
abline(lm(regrs[[14]] ~ dat[,1]), col = "red")
```

## Factor regression

> The value of R-squared of the factor regression is the same as the previous OLS (0.61).

```{r}
summary(lm(regrs[[14]] ~ dat[,1] + dat[,2] + dat[,3]))
```


## Cluster within cluster sum of squares (WCSS)

> A cluster analysis was done to further study the featured census tracks. It shows clustering three would be appropriate. 

```{r}
wss <- (nrow(dat)-1)*sum(apply(dat,2,var))
for (i in 2:9) wss[i] <- sum(kmeans(dat,centers=i)$withinss)
plot(1:9, wss, type="b", xlab="Number of Clusters",ylab="Within groups sum of squares")
```


```{r}

performance=c()
for (i in rep(1:100,times=30)) {
  clust=kmeans(dat,i)
  performance=c(performance,1-clust$tot.withinss/clust$totss)
}
perf_df=data.frame(metrics=performance,number_of_center=rep(1:100,times=30))
ggplot(perf_df,aes(x=number_of_center,y=metrics)) +
  geom_point(alpha=0.2) +
  geom_vline(xintercept = 3,color='red')

```

## Cluster analysis


```{r}
set.seed(5099)
kme <- kmeans(dat,center=3)
table(kme$cluster) #number of samples in each cluster
Group1 <- kme$centers[1,]
Group2 <- kme$centers[2,]
plot(Group1,Group2,type="n")
text(Group1,Group2, labels=colnames(dat))
sum(kme$withinss)
```


## Cluster plot

> Based on the 3 factors, 3 cluasters are presented in colors. 

```{r}
pairs(dat, col=kme$cluster)
clusplot(dat, kme$cluster, color=TRUE,shade=TRUE, labels=5, lines=0)
```

## 3D plot
```{r}
library(rgl)
plot3d(fa$scores, col = kme$cluster)
```

![](./Figs/3D.jpg)

## 3 clusters in Seattle 

> 3 clusters were identified with the census track in Seattle. 

<center>

![Clustered census track](./Figs/cluster.png){width=450px}

</center>


## Cluster with boxplot

> Each cluster shows unique features. Green groups comparatively have less housing stability and economic status while higher income inequality. Light blue groups are relatively opposite to the green groups. Light red groups keep their position in the middle of these 2 groups. 

```{r}
dat <- as.data.frame(dat)
dat$cluster=as.factor(kme$cluster)
ggpairs(dat, mapping=aes(color=cluster))+
  theme_bw()
```

## Cluster plot with smooth

```{r}
ggpairs(dat, columns = 1:3,
        aes(color=cluster, alpha=0.4),
        title="Scatterplot Matrix",
        upper=list(continuous="density", combo="box"),
        lower=list(continuous="smooth", combo="dot")) +
  theme_light() +
  theme(plot.title=element_text(size=10))+
  theme_bw()
```

## Residential solar installation pattern in terms of clustering groups 

> Residential solar installation is exactly showing the same pattern of the 1st factor (ML1), the housing stability in clustering. 

```{r}
c_reg <- regrs
c_reg$cluster <- as.factor(kme$cluster)

c_reg %>%
  ggplot(aes(x = cluster, y = sol_instl, color = cluster)) +
  geom_boxplot() +
  ggtitle("Solar installation pattern per cluster")+
  theme_bw()

```


## Residential solar installation in Low Income Tex Credit

> It indicates that lower solar installation rate and lower total number of owner-occupied units with housing costs greater than $1000/month match the certified LIHTC census tracks (TRUE). 

```{r}

c_reg %>%
  ggplot(aes(x = hu_ex_1000, y = sol_instl, color = cluster, size = lihtc)) +
  geom_point() +
  ggtitle("Solar installation pattern per cluster")+
  theme_bw()
```

## Residential solar installation in housing unit median value

> Hihger solar installation is correlated with higher housing unit median value.  Cluster #3, #1 and #2 are in order of higher solar installation. 


```{r}
c_reg %>%
ggplot(aes(x = hu_med_val, y = sol_instl, color = cluster)) +
  geom_point(alpha = 0.4)+
  geom_smooth(span = 0.9)+
  theme_bw()
```


## Cumulative solar installation per census track

> Time series analysis will help to understand the spatial-temporal pattern of residential solar installation in Seattle. Interestingly, one census track is noticably high in installation over the period. 

```{r}
temp_spatial %>%
  filter(date > as.Date("01/01/2005", "%m/%d/%Y")) %>%
  ggplot(aes(x = date, y = sum, group = geoid, color = `Over 20`))+
  geom_line(size = 1, alpha = 0.4)+
  scale_color_manual(name ="Above 20 installations", values = c("red", "black"))+
  xlab("Year") + ylab("Cumulative number of installation") +
  theme_bw() +
  theme(legend.position = c(0.2, 0.7),
        legend.background = element_rect(fill="transparent")) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y")
```

## Residental solar installation trend in Seattle 

> Two different cumulative installation pattern and annual new installation pattern are mapped in each census track in Seattle. It shows cumulative number of installation is different from the annual new installation in that every year had different installation trend depending on census tracks. In addition, hotspot outlier analysis was performed for the annual new installation map. 


<center>

![Spatial-temporal installation in Seattle](./Figs/temporal-hotspot.png){width=650px}

</center>

## Spatial-temporal hotspot analysis 

> The difference between cumulative number of installation hotspot and annual new installation hotspot shows the emerging area of increasing installation pattern in residential solar. It is noticable that West Seattle recenlty increases the installation while Ballad used to the one but goes slow these days. Columbia city presents both of cases that it has been and still maintaining the higher rate of installation. It's found that these areas are all clustered as light red (#1) and ligth blue (#3). 

<center>

![Hotspot for spatial-temporal cumulative installation in Seattle](./Figs/temporal-hotspot1.png){width=650px}

</center>

<center>

![Hotspot for spatial-temporal annual installation in Seattle](./Figs/temporal-hotspot2.png){width=650px}

</center>